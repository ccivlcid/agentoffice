# HAIFeR Agent 회의 & 리뷰 프로세스

---

## 1. 기획 승인 회의 (Planned Approval Meeting)

태스크 실행 전, team_leader의 승인을 받는 프로세스.

### 흐름

```
태스크 생성 → planned 상태
  ↓
기획팀 리더가 회의 시작 (startPlannedApprovalMeeting)
  ↓
참석자: 기획팀 리더 + 해당 부서 리더들 (최대 6명)
  ↓
각 리더가 피드백 제출 (runAgentOneShot, 35초 타임아웃)
  ↓
의사결정 분류 (classifyMeetingReviewDecision)
  ├── Approved → 즉시 실행
  ├── Hold → 수정 요청 (seedReviewRevisionSubtasks)
  └── Supplementary → 새 리뷰 라운드 시작
```

### 회의록
- `meeting_minutes` — 회의 메타데이터 (타입, 라운드, 상태)
- `meeting_minute_entries` — 각 발언 기록 (발언자, 순서, 내용)

---

## 2. 실행 후 리뷰 회의 (Review Meeting)

태스크 실행 완료 후 코드/결과를 리뷰하는 프로세스.

### 흐름

```
태스크 완료 → review 상태
  ↓
team_leader들이 결과 리뷰
  ↓
수정 메모 제출 (라운드당 최대 20개, 부서당 최대 10개)
  ↓
합의 회의 (startReviewConsensusMeeting)
  ├── Approved → done 상태
  └── Revision Requested → 수정 후 재실행 → review
```

### 리뷰 제한
- **최대 라운드**: `REVIEW_MAX_ROUNDS` (기본 3, 최대 5)
- **수정 메모**: 라운드당 20개, 부서당 10개
- **전체 수정 메모**: 태스크당 최대 100개
- **중복 방지**: `review_revision_history` UNIQUE(task_id, normalized_note)

---

## 3. 의사결정 Inbox

CEO가 승인/지시를 내리는 중앙 의사결정 인터페이스.

### 의사결정 유형

| 유형 | 설명 | 처리 함수 |
|------|------|-----------|
| Project Review | 프로젝트 단위 태스크 실행 승인 | `handleProjectReviewReply()` |
| Review Round | 코드 리뷰 결과 결정 | `handleReviewRoundReply()` |
| Supplement Round | 리뷰 피드백 후 재실행 승인 | `handleTimeoutResumeReply()` |

### 처리 흐름

```
의사결정 항목 수집 (GET /api/decision-inbox)
  ↓
CEO가 옵션 선택 + 선택적 추가 요청 입력
  ↓
응답 제출 (POST /api/decision-inbox/:id/reply)
  ↓
유형별 분기 처리
  ├── 실행 승인 → startTaskExecutionForAgent()
  ├── 수정 요청 → seedReviewRevisionSubtasks()
  └── 추가 요청 → 기존 task의 subtask로 추가
```

---

## 4. CEO 디렉티브 → 부서 위임

CEO 지시가 태스크로 변환되는 프로세스.

### 흐름

```
CEO 메시지 ($ 접두사)
  ↓
프로젝트 확인/선택 (기존 or 신규)
  ↓
POST /api/inbox (x-inbox-secret 헤더)
  ↓
서버가 전사 브로드캐스트
  ↓
기획팀에 위임 → planned 상태 태스크 생성
  ↓
부서 멘션 감지 → 부서간 협업 시작 (선택)
  ↓
기획 회의 → 서브태스크 분배 → 실행
```

### 크로스 디파트먼트 감지
- `detectTargetDepartments()` — 메시지에서 부서 멘션 탐색
- `handleMentionDelegation()` — 멘션된 부서에 알림 전송
- `crossDeptNextCallbacks` — 순차 실행 콜백 관리

---

## 5. 스킬 학습 워크플로우

에이전트의 능력 확장을 위한 스킬 학습 프로세스.

### 흐름

```
스킬 라이브러리에서 스킬 선택
  ↓
POST /api/skills/learn (repo URL, skill ID, 대상 프로바이더)
  ↓
npx skills add 명령 실행 (백그라운드)
  ↓
결과 기록 (skill_learning_history)
  ├── succeeded → 스킬 활성화
  └── failed → 에러 로그 기록
```

### 스킬 제거
- `POST /api/skills/unlearn` → `npx skills remove` (30초 타임아웃)

### 이력 관리
- 90일 보존 기간
- 프로바이더당 최대 1000건

---

## 6. Graceful Shutdown 프로세스

```
SIGTERM/SIGINT 수신
  ↓
1. 모든 활성 태스크 중지
2. 프로세스 종료 (SIGTERM → 5초 대기 → SIGKILL)
3. Git Worktree 롤백
4. WebSocket 연결 종료 (code 1001)
5. SQLite DB 안전 종료
6. 5초 타임아웃 후 강제 종료
```
