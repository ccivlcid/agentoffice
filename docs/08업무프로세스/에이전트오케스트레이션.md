# HAIFeR Agent 에이전트 오케스트레이션

---

## 1. 에이전트 구조

### 역할 (Role)
| 역할 | 설명 |
|------|------|
| `team_leader` | 부서 리더. 기획 회의 주도, 서브태스크 위임 조율 |
| `senior` | 시니어 실행자. 복잡한 태스크 담당 |
| `junior` | 주니어 실행자. 일반 태스크 담당 |
| `intern` | 인턴. 보조 작업 |

### 상태 (Status)
| 상태 | 설명 |
|------|------|
| `idle` | 대기 중 — 태스크 배정 가능 |
| `working` | 작업 중 — 태스크 실행 중 |
| `break` | 휴식 — 자동 로테이션 |
| `offline` | 오프라인 — 프로바이더 미설정 등 |

---

## 2. CLI 프로바이더 시스템

각 에이전트는 CLI 프로바이더를 통해 AI 모델과 연동:

| 프로바이더 | 실행 방식 | 파일 |
|------------|-----------|------|
| `claude` | 네이티브 프로세스 스폰 | `providers-cli.ts` |
| `codex` | 네이티브 프로세스 스폰 | `providers-cli.ts` |
| `gemini` | 네이티브 프로세스 스폰 | `providers-cli.ts` |
| `opencode` | 네이티브 프로세스 스폰 | `providers-cli.ts` |
| `copilot` | OAuth 토큰 교환 | `providers-copilot.ts` |
| `antigravity` | OAuth 토큰 리프레시 | `providers-antigravity.ts` |
| `api` | HTTP API 호출 | `providers-apiprovider.ts` |

### 프로세스 관리 (`providers-process.ts`)
- PID 추적 및 라이프사이클 관리
- 시그널 처리 (SIGTERM → SIGKILL)
- 유휴/강제 타임아웃

---

## 3. 자동 배정 시스템

`server/modules/lifecycle/auto-assign.ts` — 5초마다 실행

1. 설치된 CLI 도구 감지 (`GET /api/cli-status`)
2. 프로바이더 미설정 에이전트 탐색
3. 기본 설정(`auto_assign_provider`)에 따라 자동 배정
4. 사용자 수동 설정 우선

---

## 4. 서브태스크 위임

부서간 협업이 필요한 경우 서브태스크가 생성되고 위임:

```
상위 태스크 (기획팀)
├── 서브태스크 A → 개발팀 team_leader → 개발팀 실행자
├── 서브태스크 B → 디자인팀 team_leader → 디자인팀 실행자
└── 서브태스크 C → QA팀 team_leader → QA팀 실행자
```

### 위임 흐름
1. 서브태스크 생성 — `target_department_id` 지정
2. 부서별 배치 그룹화 (900~1600ms 간격)
3. 대상 부서 team_leader가 최적 실행자 선정
4. 위임 태스크 생성 (`delegated_task_id` 매핑)
5. 실행자가 상위 태스크 컨텍스트 포함 프롬프트로 실행
6. 전체 서브태스크 완료 시 CEO에게 통보

### 상태 추적
- `subtaskDelegationDispatchInFlight` — 동시 위임 방지
- `delegatedTaskToSubtask` — 위임↔서브태스크 매핑
- `subtaskDelegationCompletionNoticeSent` — 중복 통보 방지

---

## 5. 프롬프트 빌딩 시스템

`server/modules/workflow/core-prompt-*.ts`

### 태스크 실행 프롬프트
- 사용 가능 스킬 블록 (프로바이더별)
- 태스크 실행 컨텍스트 (이전 대화, 연속 실행)
- 에이전트 역할/부서 제약
- Git Worktree 정보
- 경고 수정 오버라이드 힌트

### 미팅 프롬프트
- 태스크 설명 및 목표
- 부서/역할 컨텍스트
- 리뷰 정책 (MVP 코드 리뷰 기준)
- 이전 수정 메모 이력
- 액션 아이템 및 산출물

---

## 6. 라이프사이클 타이머

| 타이머 | 주기 | 역할 |
|--------|------|------|
| 휴식 로테이션 | 60초 | 에이전트 break 상태 순환 |
| 고아 태스크 스위프 | 30초 | 방치된 in_progress 태스크 감지/복구 |
| 서브태스크 위임 스위프 | 5초 | 대기 중 위임 처리 |
| 자동 프로바이더 배정 | 5초 | 미설정 에이전트에 프로바이더 배정 |
| OAuth 토큰 리프레시 | 5분 | Google Antigravity 토큰 갱신 |

---

## 7. 인메모리 상태 맵

`server/modules/workflow/orchestration/state.ts`

| 맵 | 용도 |
|----|------|
| `progressTimers` | 태스크별 진행 타이머 |
| `crossDeptNextCallbacks` | 부서간 순차 실행 콜백 |
| `reviewRoundState` | 태스크별 현재 리뷰 라운드 |
| `reviewInFlight` | 중복 리뷰 미팅 방지 락 |
| `meetingPresenceUntil` | 에이전트 미팅 참석 시각 |
| `meetingSeatIndexByAgent` | 미팅 좌석 배치 (최대 6석) |
| `meetingPhaseByAgent` | `kickoff` / `review` 페이즈 |
| `taskExecutionSessions` | 활성 실행 세션 (sessionId, provider 등) |
