# HAIFeR Agent 태스크 라이프사이클

---

## 1. 태스크 상태 흐름

```
inbox → planned → collaborating → in_progress → review → done
                                                  ↓
                                               cancelled
```

| 상태 | 설명 |
|------|------|
| `inbox` | 새로 접수된 태스크 |
| `planned` | 기획 완료, 실행 대기 |
| `collaborating` | 부서간 협업 진행 중 |
| `in_progress` | 에이전트가 실행 중 |
| `review` | 리뷰/승인 대기 |
| `done` | 완료 |
| `cancelled` | 취소됨 |
| `pending` | 보류 (추가 정보 필요) |

---

## 2. 태스크 생성

### 생성 경로
1. **UI 직접 생성**: TaskBoard에서 Create 모달 사용
2. **CEO 디렉티브**: ChatPanel에서 `$` 접두사로 지시
3. **시스템 자동**: 서브태스크 위임으로 자동 생성
4. **API 직접 호출**: `POST /api/tasks`

### 생성 시 필수 정보
- `title` — 태스크 제목
- `department_id` — 배정 부서 (선택)
- `project_id` — 연결 프로젝트 (선택)
- `task_type` — `general` / `development` / `design` / `analysis` / `presentation` / `documentation`

---

## 3. 배정 & 실행

### 에이전트 배정
1. 에이전트를 태스크에 수동 배정 (`POST /api/tasks/:id/assign`)
2. 또는 자동 배정 시스템이 부서 내 최적 에이전트 선택

### 실행 시작 (`POST /api/tasks/:id/run`)
1. 태스크 상태 → `in_progress`
2. 실행 세션 생성 (sessionId, agentId, provider)
3. Git Worktree 생성 (개발 태스크 시)
4. CLI 에이전트 프로세스 스폰 (프로바이더별)
5. 진행 타이머 브로드캐스트 시작

### 실행 모니터링
- **CLI 출력 스트리밍**: WebSocket `cli_output` (250ms 배칭)
- **태스크 로그**: `task_logs` 테이블에 기록
- **세션 추적**: PID, 프로세스 상태 모니터링

### 실행 중지/재개
- `POST /api/tasks/:id/stop` — 일시정지 또는 취소
- `POST /api/tasks/:id/resume` — 재개
- 프로세스 우아한 종료 (SIGTERM → 타임아웃 → SIGKILL)

---

## 4. 실행 완료

1. `handleTaskRunComplete()` — 프로세스 종료 시 트리거
2. 종료 코드 평가 (성공/실패)
3. 성공 시 → `review` 상태로 전환
4. 리뷰 미팅 자동 시작
5. 실행 세션 종료 및 로그 기록

---

## 5. 리뷰 프로세스

→ **회의리뷰프로세스.md** 참조

---

## 6. 완료 후

- 태스크 상태 → `done`
- 태스크 리포트 생성 (summary_markdown)
- 에이전트 통계 업데이트 (tasks_done++, xp++)
- Git Worktree → dev 브랜치 머지 가능 (`POST /api/tasks/:id/merge`)
- 또는 변경사항 폐기 (`POST /api/tasks/:id/discard`)

---

## 7. 태스크 유형별 처리

| 유형 | 특수 처리 |
|------|-----------|
| `development` | Git Worktree 생성, diff 뷰, merge/discard |
| `design` | 디자인팀 에이전트 배정 |
| `analysis` | 분석 결과 리포트 생성 |
| `presentation` | PPT 생성 (pptxgenjs) |
| `documentation` | 문서 생성/수정 |
| `general` | 범용 실행 |
