# HyperClaw v1.1.6 Release Notes

- Release date: 2026-02-22
- Scope: GitHub project integration — dev-branch merge + automatic PR creation workflow, GitHub Import enhancements, base-branch support for worktrees, frontend bugfixes, and post-release hardening for subtask delegation/worktree merge safety.

## Highlights

- **GitHub Project Dev-Branch Merge + PR Flow**
  - For GitHub-imported projects (`github_repo` set), completed tasks now merge into `dev` branch instead of `main`.
  - After merging to `dev`, the branch is pushed to origin and a GitHub Pull Request (dev → main) is automatically created.
  - If an open dev → main PR already exists, the push updates it automatically without creating a duplicate.
  - Local-only projects (no `github_repo`) retain the existing direct-to-main merge behavior.

- **`github_repo` Column & API Support**
  - Added `github_repo TEXT` column to the `projects` table (nullable, format: `owner/repo`).
  - `POST /api/projects` and `PATCH /api/projects/:id` now accept and persist `github_repo`.
  - Frontend `createProject()` and `updateProject()` API functions support `github_repo` parameter.
  - `Project` TypeScript type includes `github_repo?: string | null`.

- **GitHub Import Panel Enhancements**
  - GitHub Import now automatically sets `github_repo` to the repository's `full_name` when creating a project.
  - Fixed `process is not defined` error — removed browser-incompatible `process.env` references; `~` path resolution now handled server-side.
  - Fixed `[object Object]` project ID error — `createProject()` return value is now correctly unwrapped to `project.id`.

- **Server-Side `~` Path Resolution for Clone**
  - `POST /api/github/clone` now resolves `~` and `~/...` paths server-side, matching `normalizeProjectPathInput` behavior.

- **Base-Branch Support for Worktrees**
  - `createWorktree()` now accepts an optional `baseBranch` parameter.
  - Task execution in orchestration uses `base_branch` from the task record when creating worktrees.
  - `POST /api/tasks` now accepts and persists `base_branch` field.

- **Workflow: `mergeToDevAndCreatePR()` Function**
  - New function in `workflow/core.ts`: ensures `dev` branch exists, merges task branch with `--no-ff`, pushes to origin, and creates/updates GitHub PR asynchronously.
  - Uses `getGitHubToken()` to retrieve active GitHub OAuth token from DB for push authentication and API calls.
  - On merge conflict, aborts merge, returns to `main`, and reports conflicting files.
  - Wired through `RuntimeContext` → `WorkflowCoreExports` → `workflow.ts` → `orchestration.ts`.

- **Orchestration: GitHub-Aware Finalization**
  - `finalizeApprovedReview()` now checks `project.github_repo` before merging.
  - GitHub projects → `mergeToDevAndCreatePR()` with multilingual "(dev merge + PR)" note.
  - Local projects → existing `mergeWorktree()` with "(merged)" note (unchanged).

- **Subtask Batch Delegation: Worktree Enforcement Across Providers**
  - Batched delegated subtasks now use isolated Git worktrees across all supported execution providers:
    - CLI: `claude`, `codex`, `gemini`, `opencode`
    - OAuth/API: `copilot`, `antigravity`, `api`
  - Delegated runs now execute from `agentCwd` (`worktreePath || projectPath`) consistently, not only for selected providers.
  - For delegated Claude runs, `CLAUDE.md` is mirrored into the created worktree.
  - CEO start notifications now include isolated branch context for delegated batch runs.
  - HTTP/API delegated runs now use a shared `getNextHttpAgentPid()` allocator to guarantee globally unique fake PID assignment across route/orchestration modules.

- **Delegated Task Cancellation Safety**
  - `POST /api/tasks/:id/stop` now performs delegated-workflow cleanup when cancelling:
    - clears delegation callback/maps (`delegatedTaskToSubtask`, `subtaskDelegationCallbacks`, `crossDeptNextCallbacks`)
    - clears per-parent queue flags (`subtaskDelegationDispatchInFlight`, `subtaskDelegationCompletionNoticeSent`) only when no other delegated child task is still active
    - appends parent-task delegation-stop audit logs
    - executes pending delegated batch callback before callback-map deletion so parent `runQueue(index+1)` continues even when a delegated HTTP/API task is cancelled
  - Linked subtasks are moved to `blocked` only for non-terminal states; already `done`/`blocked`/`cancelled` subtasks are preserved.
  - Prevents stale callback continuation and queue-state leakage after cancelled delegated runs.
  - HTTP-provider delegation callback now has a cancelled/pending guard to prevent late callback races from mutating subtask state after cancellation.
  - Cancelled/skipped delegation callbacks now always call `originalCallback` (queue advancer) to prevent permanent stall of remaining department batch queues.
  - `cancelDelegatedWorkflowState` fires the pending delegation callback before deleting it, ensuring the parent task's serial dispatch queue advances even on cancellation.

- **Worktree Merge Safety: Pending-Change Auto-Commit**
  - Added pre-merge auto-commit in both `mergeWorktree()` and `mergeToDevAndCreatePR()` to prevent silent loss of uncommitted worktree edits.
  - Auto-commit stages:
    - tracked changes via `git add -u`
    - safe untracked files via allowlist (extensions/basenames/dot-dir allowlist)
  - Restricted untracked paths (secrets/archives/db/log/binary-sensitive paths, blocked dirs) are excluded and logged to task logs.
  - Safe untracked staging now uses chunked `git add` to reduce large-batch spawn overhead.
  - Merge failure messaging now distinguishes `restricted untracked files` (policy block) from generic git execution errors.
  - Worktree diff summary now includes uncommitted worktree status when present.

## Changed Files

### Frontend
- `src/api.ts`
- `src/components/GitHubImportPanel.tsx`
- `src/types/index.ts`

### Backend
- `server/server-main.ts`
- `server/modules/routes/core.ts`
- `server/modules/routes/collab.ts`
- `server/modules/routes/ops.ts`
- `server/modules/workflow/core.ts`
- `server/modules/workflow/agents.ts`
- `server/modules/workflow/agents/providers.ts`
- `server/modules/workflow/orchestration.ts`
- `server/modules/workflow.ts`
- `server/types/runtime-context.ts`

### Docs
- `README.md`
- `README_ko.md`
- `README_jp.md`
- `README_zh.md`
- `docs/releases/README.md`
- `docs/releases/v1.1.6.md`

## Verification

- `pnpm run build`
  - `tsc --noEmit` passed
  - `vite build` passed
- `pnpm run test:api`
  - api tests passed
- `pnpm run test`
  - web + api test suites passed

## Notes

- GitHub PR creation is fire-and-forget (async) — the synchronous merge+push completes first, then PR is created/updated in the background with task log entries.
- The `dev` branch is automatically created from `main` if it doesn't exist when the first GitHub-project task completes.
- `cleanupWorktree` only deletes the task branch (`climpire/xxx`); `dev` branch is always preserved.
- If only restricted untracked files remain in a worktree, auto-commit is intentionally blocked and merge returns an explicit pre-merge error.
