# HAIFeR Agent ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

---

## 1. ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ

- **ë¹„íŒŒê´´ì  ë§ˆì´ê·¸ë ˆì´ì…˜**: `IF NOT EXISTS`, `ALTER TABLE ADD COLUMN`(ì´ë¯¸ ì¡´ì¬ ì‹œ ë¬´ì‹œ)
- **CHECK ì œì•½ í™•ì¥**: í…Œì´ë¸” ì¬ìƒì„± ë°©ì‹ (CREATE NEW â†’ INSERT SELECT â†’ DROP â†’ RENAME)
- **2ë‹¨ê³„ ì‹œìŠ¤í…œ**: `migrations-part1.ts` â†’ `migrations-part2.ts` ìˆœì°¨ ì‹¤í–‰
- **FK ë³µêµ¬**: `migrations-fk-repair.ts` â€” ë ˆê±°ì‹œ ì°¸ì¡° ë¬´ê²°ì„± ë³µì›

---

## 2. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ êµ¬ì¡°

```
server/init/
â”œâ”€â”€ schema.ts              # ì½”ì–´ 13ê°œ í…Œì´ë¸” ìƒì„±
â”œâ”€â”€ schema-extended.ts     # í™•ì¥ 11ê°œ í…Œì´ë¸” ìƒì„±
â”œâ”€â”€ migrations-part1.ts    # 1ë‹¨ê³„ ë§ˆì´ê·¸ë ˆì´ì…˜
â”œâ”€â”€ migrations-part2.ts    # 2ë‹¨ê³„ ë§ˆì´ê·¸ë ˆì´ì…˜
â”œâ”€â”€ migrations-fk-repair.ts # FK ì°¸ì¡° ë³µêµ¬
â”œâ”€â”€ seed-data.ts           # ê¸°ë³¸ ë°ì´í„° ì‹œë”©
â”œâ”€â”€ helpers.ts             # íŠ¸ëœì­ì…˜/ìœ í‹¸ë¦¬í‹°
â”œâ”€â”€ message-idempotency.ts # ë©±ë“±ì„± ì²˜ë¦¬
â””â”€â”€ security-audit.ts      # ë³´ì•ˆ ê°ì‚¬ ì´ˆê¸°í™”
```

---

## 3. Part 1 ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚´ìš©

| í•­ëª© | ì„¤ëª… |
|------|------|
| OAuth ì»¬ëŸ¼ ì¶”ê°€ | agents í…Œì´ë¸”ì— `oauth_account_id`, `api_provider_id`, `api_model` ì¶”ê°€ |
| CLI í”„ë¡œë°”ì´ë” í™•ì¥ | CHECK ì œì•½ì— `copilot`, `antigravity`, `api` ì¶”ê°€ |
| API í”„ë¡œë°”ì´ë” íƒ€ì… í™•ì¥ | `cerebras` ë“± ì‹ ê·œ íƒ€ì… ì¶”ê°€ (í…Œì´ë¸” ì¬ìƒì„±) |
| ì—ì´ì „íŠ¸ ë§ˆì´ê·¸ë ˆì´ì…˜ | ê¸°ì¡´ ì—ì´ì „íŠ¸ì˜ OAuth/API í•„ë“œ ë§¤í•‘ |

---

## 4. Part 2 ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚´ìš©

| í•­ëª© | ì„¤ëª… |
|------|------|
| ì„œë¸ŒíƒœìŠ¤í¬ ìœ„ì„ ì»¬ëŸ¼ | `target_department_id`, `delegated_task_id` ì¶”ê°€ |
| ë¶€ì„œê°„ í˜‘ì—… | í¬ë¡œìŠ¤ ë””íŒŒíŠ¸ë¨¼íŠ¸ ì›Œí¬í”Œë¡œìš° ì§€ì› |
| íƒœìŠ¤í¬ ìˆ¨ê¹€ ìƒíƒœ | `hidden` ì»¬ëŸ¼ ì¶”ê°€ |
| ë©”ì‹œì§€ ë””ë ‰í‹°ë¸Œ | `message_type`ì— `directive` ì¶”ê°€ |
| ë ˆê±°ì‹œ ìƒíƒœ ìŠ¤í‚¤ë§ˆ | íƒœìŠ¤í¬ ìƒíƒœ enum í™•ì¥ |

---

## 5. FK ë³µêµ¬ ë§ˆì´ê·¸ë ˆì´ì…˜

ë ˆê±°ì‹œ ë°ì´í„°ì—ì„œ ë°œìƒí•œ ì™¸ë˜í‚¤ ì°¸ì¡° ë¶ˆì¼ì¹˜ë¥¼ ìˆ˜ì •:

- `messages` â€” task_id ì°¸ì¡° ë³µêµ¬
- `task_logs` â€” task_id ì°¸ì¡° ë³µêµ¬
- `subtasks` â€” task_id ì°¸ì¡° ë³µêµ¬
- `meeting_minutes` â€” task_id ì°¸ì¡° ë³µêµ¬
- `meeting_minute_entries` â€” meeting_id ì°¸ì¡° ë³µêµ¬

---

## 6. ì‹œë“œ ë°ì´í„°

### ê¸°ë³¸ 6ê°œ ë¶€ì„œ
| ID | ì´ë¦„ | í•œê¸€ëª… | ì•„ì´ì½˜ |
|----|------|--------|--------|
| planning | Planning | ê¸°íšíŒ€ | ğŸ“‹ |
| development | Development | ê°œë°œíŒ€ | ğŸ’» |
| design | Design | ë””ìì¸íŒ€ | ğŸ¨ |
| qa | QA/QC | QAíŒ€ | ğŸ” |
| devsecops | DevSecOps | DevSecOpsíŒ€ | ğŸ›¡ï¸ |
| operations | Operations | ìš´ì˜íŒ€ | âš™ï¸ |

### ê¸°ë³¸ 12ê°œ ì—ì´ì „íŠ¸
ê° ë¶€ì„œë³„ team_leader 1ëª… + subordinate 1ëª…

### ê¸°ë³¸ ì„¤ì •
- `company_name`: "HAIFeR Agent"
- `ceo_name`: "CEO"
- `auto_assign_provider`: "claude"
- `language`: "ko"
- ë£¸ í…Œë§ˆ ìƒ‰ìƒ ë“±

---

## 7. ì•ˆì „í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒ¨í„´

```typescript
// ì»¬ëŸ¼ ì¶”ê°€ (ì´ë¯¸ ì¡´ì¬ ì‹œ ë¬´ì‹œ)
try {
  db.exec("ALTER TABLE agents ADD COLUMN oauth_account_id TEXT")
} catch { /* already exists */ }

// CHECK ì œì•½ í™•ì¥ (í…Œì´ë¸” ì¬ìƒì„±)
const hasCerebras = sql.includes("'cerebras'")
if (!hasCerebras) {
  db.exec("CREATE TABLE api_providers_new (...)")
  db.exec("INSERT INTO api_providers_new SELECT * FROM api_providers")
  db.exec("DROP TABLE api_providers")
  db.exec("ALTER TABLE api_providers_new RENAME TO api_providers")
}
```

---

## 8. ë°ì´í„° ì¼ê´€ì„± ê¸°ëŠ¥

| ê¸°ëŠ¥ | ì„¤ëª… |
|------|------|
| **ë©±ë“±ì„± í‚¤** | ë©”ì‹œì§€ ì¤‘ë³µ ë°©ì§€ (`idempotency_key` UNIQUE) |
| **ì°¸ì¡° ë¬´ê²°ì„±** | FK ì œì•½ + CASCADE DELETE |
| **íƒ€ì„ìŠ¤íƒ¬í”„** | ëª¨ë“  í…Œì´ë¸” `created_at`/`updated_at` |
| **ì†Œí”„íŠ¸ ì‚­ì œ** | íƒœìŠ¤í¬ `hidden` í”Œë˜ê·¸ (ë¬¼ë¦¬ ì‚­ì œ ì•„ë‹˜) |
| **ìœ ë‹ˆí¬ ì œì•½** | `review_revision_history(task_id, normalized_note)` |
