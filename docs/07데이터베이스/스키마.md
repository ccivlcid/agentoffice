# HAIFeR Agent ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

> SQLite 3 | WAL ëª¨ë“œ | FK í™œì„± | ìµœì¢… ê°±ì‹ : 2026-02-26

---

## 1. ê°œìš”

- **DB ìœ í˜•**: SQLite 3 (ì„ë² ë””ë“œ, ì œë¡œ ì„¤ì •)
- **íŒŒì¼ ìœ„ì¹˜**: `hyperclaw.sqlite` (ê¸°ë³¸) â€” `DB_PATH` í™˜ê²½ë³€ìˆ˜ë¡œ ë³€ê²½ ê°€ëŠ¥
- **ë ˆê±°ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜**: `climpire.sqlite` â†’ `hyperclaw.sqlite` ìë™ ì „í™˜
- **ì£¼ìš” ì„¤ì •**: WAL ëª¨ë“œ, FK ON, BUSY_TIMEOUT 5000ms

---

## 2. ì¡°ì§ í…Œì´ë¸”

### departments (ë¶€ì„œ)

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ì„¤ëª… |
|------|------|------|------|
| `id` | TEXT | PK | ë¶€ì„œ ì‹ë³„ì |
| `name` | TEXT | NOT NULL | ì˜ë¬¸ ë¶€ì„œëª… |
| `name_ko` | TEXT | NOT NULL | í•œê¸€ ë¶€ì„œëª… |
| `icon` | TEXT | NOT NULL | ì´ëª¨ì§€ ì•„ì´ì½˜ |
| `color` | TEXT | NOT NULL | HEX ìƒ‰ìƒ ì½”ë“œ |
| `description` | TEXT | - | ë¶€ì„œ ì„¤ëª… |
| `sort_order` | INTEGER | DEFAULT 99 | ì •ë ¬ ìˆœì„œ |
| `created_at` | INTEGER | DEFAULT now | ìƒì„± ì‹œê°(ms) |

### agents (ì—ì´ì „íŠ¸)

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ì„¤ëª… |
|------|------|------|------|
| `id` | TEXT | PK | ì—ì´ì „íŠ¸ UUID |
| `name` | TEXT | NOT NULL | ì˜ë¬¸ ì´ë¦„ |
| `name_ko` | TEXT | NOT NULL | í•œê¸€ ì´ë¦„ |
| `department_id` | TEXT | FKâ†’departments | ì†Œì† ë¶€ì„œ |
| `role` | TEXT | CHECK | `team_leader` / `senior` / `junior` / `intern` |
| `cli_provider` | TEXT | CHECK | `claude` / `codex` / `gemini` / `opencode` / `copilot` / `antigravity` / `api` |
| `oauth_account_id` | TEXT | - | OAuth ê³„ì • ì°¸ì¡° |
| `api_provider_id` | TEXT | - | API í”„ë¡œë°”ì´ë” ID |
| `api_model` | TEXT | - | ì»¤ìŠ¤í…€ API ëª¨ë¸ëª… |
| `avatar_emoji` | TEXT | DEFAULT 'ğŸ¤–' | ì—ì´ì „íŠ¸ ì´ëª¨ì§€ |
| `personality` | TEXT | - | ì„±ê²© ì„¤ëª… |
| `status` | TEXT | DEFAULT 'idle' | `idle` / `working` / `break` / `offline` |
| `current_task_id` | TEXT | - | í˜„ì¬ ë°°ì • íƒœìŠ¤í¬ |
| `stats_tasks_done` | INTEGER | DEFAULT 0 | ì™„ë£Œ íƒœìŠ¤í¬ ìˆ˜ |
| `stats_xp` | INTEGER | DEFAULT 0 | ê²½í—˜ì¹˜ |
| `created_at` | INTEGER | DEFAULT now | ìƒì„± ì‹œê° |

---

## 3. íƒœìŠ¤í¬ í…Œì´ë¸”

### tasks (íƒœìŠ¤í¬)

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ì„¤ëª… |
|------|------|------|------|
| `id` | TEXT | PK | íƒœìŠ¤í¬ UUID |
| `title` | TEXT | NOT NULL | ì œëª© |
| `description` | TEXT | - | ì„¤ëª… |
| `department_id` | TEXT | FKâ†’departments | ë°°ì • ë¶€ì„œ |
| `assigned_agent_id` | TEXT | FKâ†’agents | ë°°ì • ì—ì´ì „íŠ¸ |
| `project_id` | TEXT | FKâ†’projects | ì—°ê²° í”„ë¡œì íŠ¸ |
| `source_task_id` | TEXT | - | ìƒìœ„ íƒœìŠ¤í¬ (í˜‘ì—…ìš©) |
| `status` | TEXT | DEFAULT 'inbox' | `inbox` / `planned` / `collaborating` / `in_progress` / `review` / `done` / `cancelled` / `pending` |
| `priority` | INTEGER | DEFAULT 0 | ìš°ì„ ìˆœìœ„ |
| `task_type` | TEXT | DEFAULT 'general' | `general` / `development` / `design` / `analysis` / `presentation` / `documentation` |
| `project_path` | TEXT | - | í”„ë¡œì íŠ¸ ê²½ë¡œ |
| `base_branch` | TEXT | - | Git ê¸°ë°˜ ë¸Œëœì¹˜ |
| `result` | TEXT | - | ì‹¤í–‰ ê²°ê³¼ |
| `hidden` | INTEGER | DEFAULT 0 | ìˆ¨ê¹€ í”Œë˜ê·¸ |
| `started_at` | INTEGER | - | ì‹œì‘ ì‹œê° |
| `completed_at` | INTEGER | - | ì™„ë£Œ ì‹œê° |
| `created_at` | INTEGER | DEFAULT now | ìƒì„± ì‹œê° |
| `updated_at` | INTEGER | DEFAULT now | ìˆ˜ì • ì‹œê° |

### subtasks (ì„œë¸ŒíƒœìŠ¤í¬)

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ì„¤ëª… |
|------|------|------|------|
| `id` | TEXT | PK | ì„œë¸ŒíƒœìŠ¤í¬ UUID |
| `task_id` | TEXT | FKâ†’tasks ON DELETE CASCADE | ìƒìœ„ íƒœìŠ¤í¬ |
| `title` | TEXT | NOT NULL | ì œëª© |
| `description` | TEXT | - | ì„¤ëª… |
| `status` | TEXT | DEFAULT 'pending' | `pending` / `in_progress` / `done` / `blocked` |
| `assigned_agent_id` | TEXT | FKâ†’agents | ë°°ì • ì—ì´ì „íŠ¸ |
| `blocked_reason` | TEXT | - | ì°¨ë‹¨ ì‚¬ìœ  |
| `cli_tool_use_id` | TEXT | - | CLI ë„êµ¬ ì‚¬ìš© ì°¸ì¡° |
| `target_department_id` | TEXT | - | ìœ„ì„ ëŒ€ìƒ ë¶€ì„œ |
| `delegated_task_id` | TEXT | - | ìœ„ì„ íƒœìŠ¤í¬ ì°¸ì¡° |
| `created_at` | INTEGER | DEFAULT now | ìƒì„± ì‹œê° |
| `completed_at` | INTEGER | - | ì™„ë£Œ ì‹œê° |

### task_logs (íƒœìŠ¤í¬ ë¡œê·¸)

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ì„¤ëª… |
|------|------|------|------|
| `id` | INTEGER | PK AUTO | ë¡œê·¸ ID |
| `task_id` | TEXT | FKâ†’tasks | íƒœìŠ¤í¬ ì°¸ì¡° |
| `kind` | TEXT | NOT NULL | ë¡œê·¸ ìœ í˜• |
| `message` | TEXT | NOT NULL | ë¡œê·¸ ë©”ì‹œì§€ |
| `created_at` | INTEGER | DEFAULT now | ì‹œê° |

### task_creation_audits (íƒœìŠ¤í¬ ìƒì„± ê°ì‚¬)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `id` | TEXT PK | ê°ì‚¬ UUID |
| `task_id` | TEXT | íƒœìŠ¤í¬ ì°¸ì¡° |
| `trigger` | TEXT NOT NULL | íŠ¸ë¦¬ê±° ìœ í˜• (`api` / `ui` / `system`) |
| `actor_type` | TEXT | `ceo` / `agent` / `system` |
| `actor_id` | TEXT | ìˆ˜í–‰ì ID |
| `request_id` | TEXT | HTTP ìš”ì²­ ID |
| `payload_hash` | TEXT | í˜ì´ë¡œë“œ í•´ì‹œ |
| `completed` | INTEGER DEFAULT 0 | ì™„ë£Œ í”Œë˜ê·¸ |
| `created_at` | INTEGER | ì‹œê° |

---

## 4. í”„ë¡œì íŠ¸ í…Œì´ë¸”

### projects (í”„ë¡œì íŠ¸)

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ì„¤ëª… |
|------|------|------|------|
| `id` | TEXT | PK | UUID |
| `name` | TEXT | NOT NULL | í”„ë¡œì íŠ¸ëª… |
| `project_path` | TEXT | NOT NULL | íŒŒì¼ì‹œìŠ¤í…œ ê²½ë¡œ |
| `core_goal` | TEXT | NOT NULL | í•µì‹¬ ëª©í‘œ |
| `github_repo` | TEXT | - | GitHub ì €ì¥ì†Œ |
| `last_used_at` | INTEGER | - | ë§ˆì§€ë§‰ ì‚¬ìš© ì‹œê° |
| `created_at` | INTEGER | DEFAULT now | ìƒì„± ì‹œê° |
| `updated_at` | INTEGER | DEFAULT now | ìˆ˜ì • ì‹œê° |

---

## 5. ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ í…Œì´ë¸”

### messages (ë©”ì‹œì§€)

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ì„¤ëª… |
|------|------|------|------|
| `id` | TEXT | PK | ë©”ì‹œì§€ UUID |
| `sender_type` | TEXT | CHECK | `ceo` / `agent` / `system` |
| `sender_id` | TEXT | - | ë°œì‹ ì ID |
| `receiver_type` | TEXT | CHECK | `agent` / `department` / `all` |
| `receiver_id` | TEXT | - | ìˆ˜ì‹ ì ID |
| `content` | TEXT | NOT NULL | ë‚´ìš© |
| `message_type` | TEXT | DEFAULT 'chat' | `chat` / `task_assign` / `announcement` / `directive` / `report` / `status_update` |
| `task_id` | TEXT | FKâ†’tasks | ì—°ê´€ íƒœìŠ¤í¬ |
| `idempotency_key` | TEXT | UNIQUE (NULL í—ˆìš©) | ì¤‘ë³µ ë°©ì§€ í‚¤ |
| `created_at` | INTEGER | DEFAULT now | ì‹œê° |

---

## 6. íšŒì˜ & ë¦¬ë·° í…Œì´ë¸”

### meeting_minutes (íšŒì˜ë¡)

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ì„¤ëª… |
|------|------|------|------|
| `id` | TEXT | PK | íšŒì˜ UUID |
| `task_id` | TEXT | FKâ†’tasks CASCADE | ì—°ê´€ íƒœìŠ¤í¬ |
| `meeting_type` | TEXT | CHECK | `planned` / `review` |
| `round` | INTEGER | NOT NULL | ë¼ìš´ë“œ ë²ˆí˜¸ |
| `title` | TEXT | NOT NULL | íšŒì˜ ì œëª© |
| `status` | TEXT | DEFAULT 'in_progress' | `in_progress` / `completed` / `revision_requested` / `failed` |
| `started_at` | INTEGER | NOT NULL | ì‹œì‘ ì‹œê° |
| `completed_at` | INTEGER | - | ì¢…ë£Œ ì‹œê° |

### meeting_minute_entries (íšŒì˜ ë°œì–¸)

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ì„¤ëª… |
|------|------|------|------|
| `id` | INTEGER | PK AUTO | ë°œì–¸ ID |
| `meeting_id` | TEXT | FKâ†’meeting_minutes CASCADE | íšŒì˜ ì°¸ì¡° |
| `seq` | INTEGER | NOT NULL | ë°œì–¸ ìˆœì„œ |
| `speaker_agent_id` | TEXT | FKâ†’agents | ë°œì–¸ì |
| `speaker_name` | TEXT | NOT NULL | ë°œì–¸ìëª… |
| `department_name` | TEXT | - | ë¶€ì„œëª… |
| `role_label` | TEXT | - | ì—­í•  ë¼ë²¨ |
| `message_type` | TEXT | DEFAULT 'chat' | ë©”ì‹œì§€ ìœ í˜• |
| `content` | TEXT | NOT NULL | ë°œì–¸ ë‚´ìš© |

### review_revision_history (ë¦¬ë·° ìˆ˜ì • ì´ë ¥)

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ì„¤ëª… |
|------|------|------|------|
| `id` | INTEGER | PK AUTO | ID |
| `task_id` | TEXT | FKâ†’tasks CASCADE | íƒœìŠ¤í¬ |
| `normalized_note` | TEXT | NOT NULL | ì •ê·œí™”ëœ ìˆ˜ì • ë…¸íŠ¸ |
| `raw_note` | TEXT | NOT NULL | ì›ë³¸ ìˆ˜ì • ë…¸íŠ¸ |
| `first_round` | INTEGER | NOT NULL | ìµœì´ˆ ë¼ìš´ë“œ |
| - | - | UNIQUE(task_id, normalized_note) | ì¤‘ë³µ ë°©ì§€ |

---

## 7. ì˜ì‚¬ê²°ì • í…Œì´ë¸”

### project_review_decision_states (í”„ë¡œì íŠ¸ ë¦¬ë·° ì˜ì‚¬ê²°ì •)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `project_id` | TEXT PK FKâ†’projects | í”„ë¡œì íŠ¸ ì°¸ì¡° |
| `snapshot_hash` | TEXT NOT NULL | ìŠ¤ëƒ…ìƒ· í•´ì‹œ |
| `status` | TEXT | `collecting` / `ready` / `failed` |
| `planner_summary` | TEXT | ê¸°íš ìš”ì•½ |
| `planner_agent_id` | TEXT FKâ†’agents | ê¸°íš ì—ì´ì „íŠ¸ |

### project_review_decision_events (ì˜ì‚¬ê²°ì • ì´ë²¤íŠ¸)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `id` | INTEGER PK AUTO | ID |
| `project_id` | TEXT FKâ†’projects | í”„ë¡œì íŠ¸ |
| `event_type` | TEXT CHECK | `planning_summary` / `representative_pick` / `followup_request` / `start_review_meeting` |
| `summary` | TEXT NOT NULL | ì´ë²¤íŠ¸ ìš”ì•½ |
| `selected_options_json` | TEXT | ì„ íƒëœ ì˜µì…˜ (JSON) |

### review_round_decision_states (ë¦¬ë·° ë¼ìš´ë“œ ì˜ì‚¬ê²°ì •)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `meeting_id` | TEXT PK FKâ†’meeting_minutes | íšŒì˜ ì°¸ì¡° |
| `snapshot_hash` | TEXT NOT NULL | ìŠ¤ëƒ…ìƒ· í•´ì‹œ |
| `status` | TEXT | `collecting` / `ready` / `failed` |

---

## 8. OAuth & ì¸ì¦ í…Œì´ë¸”

### oauth_accounts (OAuth ê³„ì •)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `id` | TEXT PK | ê³„ì • UUID |
| `provider` | TEXT CHECK | `github` / `google_antigravity` |
| `label` | TEXT | ê³„ì • ë¼ë²¨ |
| `email` | TEXT | ì´ë©”ì¼ |
| `access_token_enc` | TEXT | ì•”í˜¸í™”ëœ ì•¡ì„¸ìŠ¤ í† í° |
| `refresh_token_enc` | TEXT | ì•”í˜¸í™”ëœ ë¦¬í”„ë ˆì‹œ í† í° |
| `status` | TEXT DEFAULT 'active' | `active` / `disabled` |
| `priority` | INTEGER DEFAULT 100 | ì„ íƒ ìš°ì„ ìˆœìœ„ |
| `failure_count` | INTEGER DEFAULT 0 | ì‹¤íŒ¨ ì¹´ìš´í„° |

### oauth_active_accounts â€” PK: (provider, account_id)
### oauth_states â€” OAuth ìƒíƒœ ê´€ë¦¬ (PKCE verifier ë“±)
### oauth_credentials â€” ë ˆê±°ì‹œ (ë‹¨ì¼ í”„ë¡œë°”ì´ë”ë‹¹ 1ê°œ)

---

## 9. ì„¤ì • & ìºì‹œ í…Œì´ë¸”

### api_providers (API í”„ë¡œë°”ì´ë”)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `id` | TEXT PK | í”„ë¡œë°”ì´ë” UUID |
| `name` | TEXT NOT NULL | ì´ë¦„ |
| `type` | TEXT DEFAULT 'openai' | `openai` / `anthropic` / `google` / `ollama` / `openrouter` / `together` / `groq` / `cerebras` / `custom` |
| `base_url` | TEXT NOT NULL | API ê¸°ë³¸ URL |
| `api_key_enc` | TEXT | ì•”í˜¸í™”ëœ API í‚¤ |
| `enabled` | INTEGER DEFAULT 1 | í™œì„± ì—¬ë¶€ |
| `models_cache` | TEXT | ìºì‹œëœ ëª¨ë¸ JSON |

### settings â€” KEY-VALUE ì €ì¥ì†Œ
### cli_usage_cache â€” CLI ì‚¬ìš©ëŸ‰ ìºì‹œ
### skill_learning_history â€” ìŠ¤í‚¬ í•™ìŠµ ì´ë ¥
### task_report_archives â€” íƒœìŠ¤í¬ ë¦¬í¬íŠ¸ ì•„ì¹´ì´ë¸Œ

### custom_skills (ë¡œì»¬ ì»¤ìŠ¤í…€ ìŠ¤í‚¬)

| ì»¬ëŸ¼ | íƒ€ì… | ì œì•½ | ì„¤ëª… |
|------|------|------|------|
| `id` | TEXT | PK | UUID |
| `name` | TEXT | NOT NULL | ìŠ¤í‚¬ ì´ë¦„ |
| `skill_id` | TEXT | NOT NULL DEFAULT '' | ìŠ¤í‚¬ ê³ ìœ  ID (ë¯¸ì…ë ¥ ì‹œ ì´ë¦„ê³¼ ë™ì¼) |
| `repo` | TEXT | NOT NULL DEFAULT '' | GitHub ì €ì¥ì†Œ (owner/repo) |
| `category` | TEXT | - | ì¹´í…Œê³ ë¦¬ (NULL í—ˆìš©) |
| `description` | TEXT | NOT NULL DEFAULT '' | ìŠ¤í‚¬ ì„¤ëª… |
| `installs` | INTEGER | NOT NULL DEFAULT 0 | ì„¤ì¹˜ ìˆ˜ |
| `created_at` | INTEGER | DEFAULT now | ìƒì„± ì‹œê°(ms) |
| `updated_at` | INTEGER | DEFAULT now | ìˆ˜ì • ì‹œê°(ms) |

---

## 10. ì¸ë±ìŠ¤

```sql
idx_subtasks_task                    (task_id)
idx_tasks_status                     (status, updated_at DESC)
idx_tasks_agent                      (assigned_agent_id)
idx_tasks_dept                       (department_id)
idx_tasks_project                    (project_id, updated_at DESC)
idx_projects_recent                  (last_used_at DESC, updated_at DESC)
idx_task_logs_task                   (task_id, created_at DESC)
idx_messages_receiver                (receiver_type, receiver_id, created_at DESC)
idx_messages_idempotency_key         UNIQUE (idempotency_key) WHERE NOT NULL
idx_meeting_minutes_task             (task_id, started_at DESC)
idx_meeting_minute_entries_meeting   (meeting_id, seq ASC)
idx_review_revision_history_task     (task_id, first_round DESC, id DESC)
idx_oauth_accounts_provider          (provider, status, priority, updated_at DESC)
idx_task_creation_audits_task        (task_id, created_at DESC)
idx_task_creation_audits_trigger     (trigger, created_at DESC)
idx_task_report_archives_root        (root_task_id, updated_at DESC)
idx_skill_learning_history_*         (providerë³„ ì¡°íšŒ ìµœì í™”)
idx_custom_skills_updated            (updated_at DESC)
```

---

## 11. ER ë‹¤ì´ì–´ê·¸ë¨ (ìš”ì•½)

```
departments (1) â”€â”€â”¬â”€â”€ (N) agents
                  â””â”€â”€ (N) tasks

agents (1) â”€â”€â”¬â”€â”€ (N) tasks
             â”œâ”€â”€ (N) subtasks
             â””â”€â”€ (N) meeting_minute_entries

projects (1) â”€â”€â”¬â”€â”€ (N) tasks
               â”œâ”€â”€ (1) project_review_decision_states
               â””â”€â”€ (N) project_review_decision_events

tasks (1) â”€â”€â”¬â”€â”€ (N) subtasks
            â”œâ”€â”€ (N) task_logs
            â”œâ”€â”€ (N) task_creation_audits
            â”œâ”€â”€ (N) messages
            â”œâ”€â”€ (N) meeting_minutes â”€â”€ (N) meeting_minute_entries
            â”œâ”€â”€ (N) review_revision_history
            â””â”€â”€ (1) task_report_archives

oauth_accounts (1) â”€â”€ (N) oauth_active_accounts
```
