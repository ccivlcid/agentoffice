# HAIFeR Agent 커스텀 훅 & 상태 관리

---

## 1. 커스텀 훅 (src/hooks/)

### useWebSocket
저수준 WebSocket 연결 관리.
- **반환**: `{ connected, on(type, listener) → unsubscribe }`
- 자동 재연결, JSON 이벤트 파싱

### useAppWebSocket
앱 수준 WebSocket 이벤트 처리.
- 에이전트/태스크/통계/의사결정 라이브 싱크 디바운싱
- 서브 에이전트 스트리밍 및 CLI 출력 파싱
- 동일성 비교로 불필요한 리렌더 방지
- 메시지/서브태스크 배열 상한 제한

### useFetchAll
앱 로드/새로고침 시 전체 데이터 일괄 조회.
- 조회: departments, agents, tasks, stats, settings, subtasks, meetingPresence, decisionInbox
- 자동 언어 감지, 룸 테마 localStorage 동기화

### usePolling
범용 폴링 훅 (탭 가시성 감지).
- **입력**: `fetcher, intervalMs, deps`
- **반환**: `{ data, loading, error, refresh }`
- 탭 숨김 시 폴링 일시정지, 복귀 시 재개

### useAppHandlers
중앙 이벤트 핸들러 팩토리 (15KB).
- sendMessage, sendAnnouncement, sendDirective
- createTask, updateTask, deleteTask, assignTask
- runTask, stopTask, pauseTask, resumeTask
- saveSettings, openChat, loadDecisionInbox, replyDecisionOption
- 비동기 처리 + 에러 핸들링 + 액션 후 상태 갱신

### useAppLabels
i18n 라벨 계산.
- `computeAppLabels(uiLanguage)` → AppLabels 객체
- `computeUpdateBannerState(params)` → 업데이트 배너 상태

### useCliOutputHandler
CLI 출력 스트림 파싱.
- 스트림 tail 캐싱, 태스크 추적
- 스레드 바인딩/프루닝 (TTL 기반)

---

## 2. 상태 관리 패턴

### 외부 라이브러리 없음
Redux, Zustand, Recoil 등 미사용. 순수 React 패턴으로 관리:

### App.tsx 리프팅 상태

**코어 데이터**
```typescript
departments: Department[]
agents: Agent[]
tasks: Task[]
messages: Message[]
stats: CompanyStats | null
settings: CompanySettings
subAgents: SubAgent[]
subtasks: SubTask[]
meetingPresence: MeetingPresence[]
```

**UI 상태**
```typescript
view: View                       // office | dashboard | tasks | skills | settings
selectedAgent: Agent | null
chatAgent: Agent | null
showChat: boolean
taskPanel: { taskId, tab } | null
showDecisionInbox: boolean
decisionInboxItems: DecisionInboxItem[]
streamingMessage: {...} | null
unreadAgentIds: Set<string>
```

### Ref 기반 상태 (리렌더 최적화)
```typescript
viewRef, agentsRef, tasksRef, subAgentsRef
activeChatRef
liveSyncInFlightRef, liveSyncQueuedRef, liveSyncTimerRef
```

### Context 기반 상태
| Context | 파일 | 용도 |
|---------|------|------|
| **ThemeContext** | `ThemeContext.tsx` | 다크/라이트 모드, localStorage 저장 |
| **I18nContext** | `i18n.ts` | 언어 설정, `t()` 번역 함수 |
| **SettingsPanelContext** | `SettingsPanelContext.tsx` | 설정 패널 복합 상태 |

### 데이터 흐름 패턴

```
서버 (Express + SQLite)
  ↕ REST API (초기 로드, CRUD)
  ↕ WebSocket (실시간 싱크)
App.tsx (글로벌 상태)
  ↓ props 전달
자식 컴포넌트 (로컬 useState)
  ↑ 콜백 핸들러 (useAppHandlers)
```

---

## 3. 실시간 동기화

### WebSocket 라이브 싱크
- `useAppWebSocket`에서 500ms 디바운싱
- 에이전트/태스크 동일성 비교 (`appEquality.ts`)
- 배열 상한: 메시지 200개, 서브태스크 100개

### 폴링 (보조)
- `usePolling` — 일정 주기 서버 데이터 조회
- 탭 가시성 API 활용 (숨김 탭 폴링 중지)

### 스트리밍 메시지
- `streamingMessage` 상태로 타이핑 인디케이터 + 컨텐츠 실시간 표시
- `chat_stream` WebSocket 이벤트 처리
