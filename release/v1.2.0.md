# HAIFeR Agent v1.2.0 — Release Notes

> 릴리즈 일자: 2026-02-26

---

## Agent Management (CRUD)

- **Hire New Agent** — Agent Manager에서 에이전트 전체 생성 UI: 이름(다국어: en/ko/ja/zh), 부서, 역할(team_leader/senior/junior/intern), CLI provider, 스프라이트 번호, 아바타 이모지, 성격 필드.
- **Edit Agent** — provider/model 재지정 포함 모든 에이전트 필드 인라인 편집.
- **Delete Agent** — 재직 상태 가드로 안전 삭제; tasks, subtasks, meeting minutes, report archives, review decision states에 대한 연쇄 NULL 처리.
- Backend: `POST /api/agents`, `PATCH /api/agents/:id`, `DELETE /api/agents/:id` 엔드포인트 및 WebSocket 브로드캐스트(`agent_created`, `agent_deleted`).

---

## Department CRUD

- **Create Department** — ID 검증(`a-z0-9` 패턴), 다국어 이름, 아이콘, 컬러 피커, 설명, 프롬프트를 지원하는 부서 생성.
- **Edit Department** — 모든 부서 속성 인라인 편집.
- **Delete Department** — 관련 에이전트/태스크 가드와 함께 삭제.
- Backend: `POST /api/departments`, `PATCH /api/departments/:id`, `DELETE /api/departments/:id` 엔드포인트 및 `departments_changed` 브로드캐스트.

---

## Department Management Tab

- Agent Manager 내 **서브탭 토글** (`Agents | Departments`) 추가.
- 부서 목록 뷰: 정렬 순서, 아이콘, 이름, 색상, 에이전트 수, 설명, ID.
- **정렬 순서 편집**: 화살표 버튼 및 드래그앤드롭, 일괄 저장.
- Backend: 재정렬 시 UNIQUE 제약 충돌 방지를 위해 임시 상대값 `sort_order`를 사용하는 `PATCH /api/departments/reorder` 엔드포인트.
- `/api/departments/reorder`가 `/api/departments/:id`에 잡히지 않도록 라우팅 가드 추가.

---

## New Character Sprite (Sprite #13)

- 전체 방향 스프라이트 세트(D-1/D-2/D-3, L-1, R-1)를 갖춘 새 픽셀 캐릭터 추가.
- 스프라이트 생성 파이프라인 스크립트 추가.
- AgentAvatar 및 OfficeView에 스프라이트 #13 지원 반영.

---

## Project Manual Agent Assignment

- 프로젝트에 `assignment_mode` 지원: `auto`(기본) 또는 `manual`.
- manual 모드에서 스프라이트 아바타 아이콘과 부서/역할 라벨이 있는 멀티셀렉트 체크박스 UI로 특정 에이전트 지정 가능.
- DB 스키마: `projects` 테이블에 `assignment_mode` 컬럼 + `project_agents` 조인 테이블.
- Backend CRUD: `POST /api/projects`, `PATCH /api/projects/:id`에서 `assignment_mode` 및 `agent_ids` 수용.
- `GET /api/projects`, `GET /api/projects/:id`에서 프로젝트별 `assigned_agent_ids` 반환.

---

## Meeting Participant Filtering (Manual Mode)

- 프로젝트가 `assignment_mode: manual`일 때 kickoff·리뷰 미팅 참가자:
  - **Planning 팀장** (항상 포함)
  - **지정된 에이전트의 부서 팀장**
- `fallbackAll`(모든 활성 팀장 초대)은 manual 모드 프로젝트에서는 사용하지 않음.
- kickoff(`startPlannedApprovalMeeting`) 및 리뷰(`startReviewConsensusMeeting`) 미팅 모두 적용.

---

## Task Delegation with Manual Mode

- `collab.ts`의 `findBestSubordinate`에 선택 인자 `candidateAgentIds` 추가.
- manual 모드에서 `project_agents`를 조회해 후보를 지정된 에이전트 풀로 제한.
- 후보 필터링은 해당 활성 팀장의 부서로 추가 제한.
- manual 모드에서 해당 부서에 지정된 후보가 없으면 전체 부서 자동 선택 폴백 차단.
- auto 모드 프로젝트는 기존 위임 로직 유지.

---

## ChatPanel Manual Mode Indicator

- 프로젝트 확인 단계에서 manual 모드 프로젝트의 지정 에이전트 수 표시 (예: "Manual mode - 2 assigned agents will work on this").

---

## Mobile-Responsive Project Manager

- **리스트-상세 토글 패턴** (mobile, `md`/768px 미만):
  - 프로젝트 미선택 시 리스트가 전체 너비.
  - 프로젝트 선택 또는 새로 만들기 시 리스트 숨김, 상세 뷰 표시.
  - 모바일 전용 뒤로가기 버튼으로 프로젝트 리스트 복귀.
- 데스크톱은 기존 좌우 레이아웃 유지.

---

## Bug Fixes

- `core.ts`의 `runInTransaction` 바인딩 미해결로 인한 프로젝트 저장 `500` 수정.
- `ProjectManagerModal` 라이트 모드 오류 가독성 개선 (`text-rose-800`/`text-cyan-800` 변형).
- `/api/departments/reorder`가 `/api/departments/:id`와 라우트 충돌로 저장 실패하던 문제 수정.
- Agent Manager 이모지 피커 내부 스크롤 (`max-h` + `overflow-y-auto`) 추가.
- Agent Manager 채용/편집 모달 내부 스크롤 (`max-h` + `overflow-y-auto`) 추가.

---

## Custom Skill Upload System

- **커스텀 스킬 CRUD** — Skills Library UI에서 `.md` 스킬 파일 직접 업로드, 스킬 이름 지정, 학습할 CLI 대표 선택, 기존 커스텀 스킬 삭제.
- **Classroom training animation** — 커스텀 스킬 업로드 시 claw-empire 마스코트가 선생님, CLI 대표 에이전트가 학생인 풀스크린 칠판 교실 애니메이션 재생.
- **Backend**: `POST /api/skills/custom`(업로드), `GET /api/skills/custom`(목록), `DELETE /api/skills/custom/:skillName`(삭제), `custom-skills/` 디렉터리 파일 저장 및 `skill_learning_history` DB 기록.
- **Frontend API**: `uploadCustomSkill()`, `getCustomSkills()`, `deleteCustomSkill()` 추가 (`src/api`).
- **라이트 모드**: 커스텀 스킬 버튼, 모달, 리스트 카드, 교실 애니메이션 오버레이에 대한 라이트 모드 CSS 오버라이드.

---

## Post-release Hardening (still v1.2.0)

- **Manual assignment pre-save safeguard modal**: 수동 지정 저장 시 에이전트 미선택 또는 팀장만 선택한 경우 요약과 함께 경고 모달, 명시적 확인 후 저장.
- **Manual selection visibility**: 수동 지정 UI에 실시간 카운트(`total`, `leaders`, `subordinates`) 표시로 하위자 누락 방지.
- **Project API `agent_ids` validation**: `POST /api/projects`, `PATCH /api/projects/:id`에서 `agent_ids` 타입·존재 검증; 잘못된 ID는 명시적 오류 페이로드로 거부.
- **Delegation fallback auditability**: manual 모드에서 지정 후보 중 적격 하위자가 없을 때 명시적 폴백 컨텍스트 로그 및 CEO 대상 안전 알림 후 팀장 직접 실행.
- **Sprite registration conflict guard**: `POST /api/sprites/register`에서 대상 스프라이트 파일이 이미 있으면 `409 sprite_number_exists` 반환해 덮어쓰기 방지.
- **Portable sprite generation script**: 스프라이트 생성 시 출력 경로를 저장소 기준으로 해석하고 `public/sprites` 자동 생성, 머신별 절대 경로 의존 제거.
- **Department sort_order UNIQUE index safe migration**: `server-main.ts`에서 sort_order 시드 업데이트 시 `idx_departments_sort_order` UNIQUE 인덱스 drop/재생성으로 마이그레이션 중 제약 위반 방지.

---

## Engineering Quality Pack (still v1.2.0)

- **Codebase modularization (frontend + backend)**  
  - Backend: 대형 라우트 도메인을 `server/modules/routes/*`, `server/modules/workflow/*` 기능 폴더로 분리 (예: `core/agents`, `core/projects`, `core/tasks`, `ops/messages`, `ops/oauth`, `ops/skills`, `ops/task-reports`, `ops/terminal`, `collab/coordination`).  
  - Frontend: 과도한 단일 파일 UI를 `src/components/*` 기능 디렉터리로 분리 (예: `office-view`, `taskboard`, `settings`, `chat`, `project-manager`, `agent-manager`) — 메인 진입 모듈 + 하위 모듈.  
  - 목표: 동작 동일 유지, 단일 파일 복잡도 감소로 리뷰·타겟 테스트·점진적 변경 용이.
- **Type-debt cleanup (`@ts-nocheck` 제거)**  
  - 서버 런타임/보안 관련 모듈에서 `@ts-nocheck` 제거, 공유/런타임 타입 경계로 명시적 대체.  
  - 기존 API 동작·응답 계약 유지하며 헬퍼 추출과 함께 리팩터링.
- **Repository-wide formatting standardization**  
  - Prettier 기준 추가 (`.prettierrc.json`, `.prettierignore`), 패키지 스크립트 `format`, `format:check`.  
  - CI에 `pnpm run format:check` 연동으로 포맷 퇴보 시 머지 전 실패.
- **Test code expansion (E2E + unit)**  
  - CI E2E 갭 스위트: `tests/e2e/ci-coverage-gap.spec.ts`.  
  - 태스크 전체 라이프사이클, Department/Agent/Project CRUD 스모크, chat/directive, settings+stats 로드, decision inbox, report/terminal, WebSocket 이벤트 수신 등 커버리지 확대.  
  - Frontend 단위 테스트: `src/api.test.ts`, `src/hooks/useWebSocket.test.tsx`, `src/hooks/usePolling.test.tsx`, `src/i18n.test.ts`.  
  - Backend 단위 테스트: `server/security/auth.test.ts`, `server/ws/hub.test.ts`, `server/db/runtime.test.ts`, `server/gateway/client.test.ts`.
- **CI E2E stabilization**  
  - E2E 커버리지 플로우에서 사용하는 폴링 경로에 일시적 502/503 재시도 처리.  
  - Playwright CI 기본값을 결정론적으로 설정 (`workers: 1`, `reuseExistingServer: false`)하여 불안정 감소.
